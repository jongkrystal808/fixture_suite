<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <link href="/app/output.css" rel="stylesheet">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>治具管理系統</title>
    <style>
    .btn{border:1px solid #D1D5DB;border-radius:12px;padding:.5rem .75rem;background:#fff}
    .btn:hover{background:#f9fafb}
    .btn-primary{background:#111827;color:#fff;border-color:#111827}
    .btn-primary:hover{background:#000}
    .input{border:1px solid #D1D5DB;border-radius:12px;padding:.5rem .75rem;width:100%}
    .tab{border:1px solid #D1D5DB;border-radius:12px;padding:.5rem .75rem;font-size:.875rem}
    .tab-active{background:#111827;color:#fff;border-color:#111827}
    .card{background:#fff;border:1px solid #E5E7EB;border-radius:16px;padding:1rem;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .table{width:100%;font-size:.875rem}
    .table th{text-align:left;color:#6B7280;font-weight:500;padding-bottom:.5rem}
    .table td{padding:.5rem 0;border-top:1px solid #E5E7EB}
    .muted{font-size:.75rem;color:#6B7280}
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <!-- Header -->
  <header class="sticky top-0 bg-white/80 backdrop-blur border-b border-gray-200">
    <div class="mx-auto max-w-7xl px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-8 w-8 rounded-xl bg-gray-900 text-white grid place-items-center font-bold">F</div>
        <div>
          <h1 class="text-lg font-semibold">治具管理系統</h1>
          <p class="text-xs text-gray-500">單頁應用 · FastAPI + MySQL</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <span id="loginState" class="text-xs text-gray-600">未登入</span>
        <button id="btnLogin" class="btn btn-primary">登入</button>
      </div>
    </div>
  </header>

  <!-- Tabs -->
  <main class="mx-auto max-w-7xl p-4 space-y-6">
    <nav id="tabs" class="grid grid-cols-2 md:grid-cols-6 gap-2">
      <button data-tab="dashboard" class="tab tab-active">儀表板</button>
      <button data-tab="material" class="tab">收/退料登記</button>
      <button data-tab="query" class="tab">查詢</button>
      <button data-tab="openstations" class="tab">開站數查詢</button>
      <button data-tab="logs" class="tab">使用/更換記錄</button>
      <button data-tab="admin" class="tab">後台管理</button>
    </nav>

    <!-- 儀表板（合併儀表板+治具統計+治具狀況總覽） -->
    <section id="tab-dashboard" class="tab-pane space-y-6">
      <div class="card space-y-4">
        <h2 class="text-lg font-semibold">治具統計總覽</h2>
        <div class="grid md:grid-cols-4 gap-4">
          <div class="card text-center bg-blue-50">
            <div class="text-gray-600 text-sm">治具總數</div>
            <div id="statTotalFixtures" class="text-4xl font-bold text-blue-600">0</div>
          </div>
          <div class="card text-center bg-green-50">
            <div class="text-gray-600 text-sm">啟用中治具</div>
            <div id="statActiveFixtures" class="text-4xl font-bold text-green-600">0</div>
          </div>
          <div class="card text-center bg-yellow-50">
            <div class="text-gray-600 text-sm">壽命內治具</div>
            <div id="statUnderLifespan" class="text-4xl font-bold text-yellow-600">0</div>
          </div>
          <div class="card text-center bg-red-50">
            <div class="text-gray-600 text-sm">需更換治具</div>
            <div id="statNeedReplacement" class="text-4xl font-bold text-red-600">0</div>
          </div>
        </div>
      </div>

      <div class="card space-y-3">
        <h2 class="text-base font-semibold">最近收料記錄</h2>
        <table class="table">
          <thead><tr><th>類型</th><th>廠商</th><th>單號</th><th>治具編號</th><th>操作人員</th><th>日期</th></tr></thead>
          <tbody id="dash-receipts"></tbody>
        </table>
      </div>

      <div class="card space-y-3">
        <h2 class="text-base font-semibold">最近退料記錄</h2>
        <table class="table">
          <thead><tr><th>類型</th><th>廠商</th><th>單號</th><th>治具編號</th><th>操作人員</th><th>日期</th></tr></thead>
          <tbody id="dash-returns"></tbody>
        </table>
      </div>
    </section>

    <!-- 收/退料登記（合併） -->
    <section id="tab-material" class="tab-pane hidden">
      <div class="card space-y-4">
        <div class="flex items-center gap-4">
          <h2 class="text-base font-semibold">收/退料登記</h2>
          <div class="flex gap-2">
            <button id="btnMaterialReceive" class="btn btn-primary">收料</button>
            <button id="btnMaterialReturn" class="btn">退料</button>
          </div>
        </div>

        <!-- 類型選擇 -->
        <div class="flex gap-2">
          <label class="flex items-center gap-2">
            <input type="radio" name="material-type" value="batch" checked />
            <span>批量</span>
          </label>
          <label class="flex items-center gap-2">
            <input type="radio" name="material-type" value="single" />
            <span>少量</span>
          </label>
        </div>

        <!-- 表單 -->
        <div class="grid md:grid-cols-4 gap-3">
          <input id="mat-vendor" class="input" placeholder="廠商" />
          <input id="mat-order-no" class="input" placeholder="單號" />
          <input id="mat-fixture-code" class="input" placeholder="治具編號" />
          <input id="mat-operator" class="input" placeholder="操作人員" readonly />
        </div>

        <!-- 批量欄位 -->
        <div id="batch-fields" class="grid md:grid-cols-2 gap-3">
          <input id="mat-serial-start" class="input" placeholder="流水號起始" />
          <input id="mat-serial-end" class="input" placeholder="流水號結束" />
        </div>

        <!-- 少量欄位 -->
        <div id="single-fields" class="grid md:grid-cols-1 gap-3 hidden">
          <input id="mat-serials" class="input" placeholder="序號（多個序號請用逗號分隔）" />
        </div>

        <div class="grid md:grid-cols-6 gap-3">
          <input id="mat-note" class="input md:col-span-4" placeholder="備註（選填）" />
          <button id="btnMatAdd" class="btn btn-primary">新增</button>
          <button id="btnMatReload" class="btn">重新整理</button>
        </div>

        <!-- 記錄表格 -->
        <div class="border-t pt-4">
          <h3 class="text-sm font-semibold mb-2" id="mat-table-title">收料記錄</h3>
          <table class="table">
            <thead>
              <tr>
                <th>ID</th><th>類型</th><th>廠商</th><th>單號</th><th>治具編號</th>
                <th>流水號/序號</th><th>操作人員</th><th>備註</th><th>日期</th><th></th>
              </tr>
            </thead>
            <tbody id="mat-tbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- 查詢 -->
    <section id="tab-query" class="tab-pane hidden">
      <div class="card space-y-3">
        <h2 class="text-base font-semibold">治具查詢</h2>
        <div class="grid md:grid-cols-5 gap-3">
          <input id="fx-q" class="input md:col-span-3" placeholder="輸入治具名稱 / 狀態關鍵字" />
          <button id="btnFxSearch" class="btn btn-primary">查詢</button>
          <button id="btnFxNew" class="btn">新增治具</button>
        </div>

        <div class="flex flex-wrap gap-2 items-center">
          <label class="btn cursor-pointer">
            匯入 Excel
            <input id="fx-import" type="file" accept=".xlsx" hidden />
          </label>
          <a class="btn" id="fx-template" href="/app/fixtures_import_template.xlsx" download>下載範本</a>
          <span class="muted">（請把 <code>fixtures_import_template.xlsx</code> 放在 <code>web/</code> 目錄以供下載）</span>
        </div>

        <table class="table">
          <thead>
            <tr><th>ID</th><th>名稱</th><th>狀態</th><th>使用次數</th><th>壽命</th><th></th></tr>
          </thead>
          <tbody id="fx-tbody"></tbody>
        </table>
      </div>
    </section>

<section id="tab-openstations" class="tab-pane hidden">
  <div class="card space-y-3">
    <h2 class="text-base font-semibold">機種最大開站數查詢</h2>
    <div class="grid md:grid-cols-4 gap-3">
      <input id="modelCode" class="input md:col-span-2" placeholder="輸入機種代碼" />
      <button id="btnCalcStations" class="btn btn-primary">查詢</button>
    </div>
    <table class="table mt-3">
      <thead><tr><th>站別</th><th>可開站數</th></tr></thead>
      <tbody id="stationTable"></tbody>
    </table>
  </div>
</section>

    <!-- 使用/更換記錄 -->
    <section id="tab-logs" class="tab-pane hidden">
      <div class="card space-y-4">
        <div class="flex items-center gap-4">
          <h2 class="text-base font-semibold">使用/更換記錄</h2>
          <div class="flex gap-2">
            <button id="btnLogUsage" class="btn btn-primary">使用記錄</button>
            <button id="btnLogReplacement" class="btn">更換記錄</button>
          </div>
        </div>

        <!-- 使用記錄表單 -->
        <div id="usage-form" class="space-y-3">
          <h3 class="text-sm font-semibold">新增使用記錄</h3>
          <div class="grid md:grid-cols-4 gap-3">
            <input id="usage-fixture-id" class="input" placeholder="治具編號" />
            <input id="usage-serial" class="input" placeholder="序號（選填）" />
            <input id="usage-station" class="input" type="number" placeholder="站別ID（選填）" />
            <input id="usage-count" class="input" type="number" placeholder="使用次數" value="1" />
          </div>
          <div class="grid md:grid-cols-4 gap-3">
            <input id="usage-abnormal" class="input" placeholder="異常狀態（選填）" />
            <input id="usage-operator" class="input" placeholder="操作人員" readonly />
            <input id="usage-note" class="input" placeholder="備註（選填）" />
            <button id="btnUsageAdd" class="btn btn-primary">新增</button>
          </div>
        </div>

        <!-- 更換記錄表單 -->
        <div id="replacement-form" class="space-y-3 hidden">
          <h3 class="text-sm font-semibold">新增更換記錄</h3>
          <div class="grid md:grid-cols-4 gap-3">
            <input id="replace-fixture-id" class="input" placeholder="治具編號" />
            <input id="replace-serial" class="input" placeholder="序號（選填）" />
            <input id="replace-date" class="input" type="date" placeholder="更換日期" />
            <input id="replace-executor" class="input" placeholder="執行人員" readonly />
          </div>
          <div class="grid md:grid-cols-4 gap-3">
            <input id="replace-reason" class="input md:col-span-2" placeholder="更換原因（選填）" />
            <input id="replace-note" class="input" placeholder="備註（選填）" />
            <button id="btnReplaceAdd" class="btn btn-primary">新增</button>
          </div>
        </div>

        <div class="flex gap-2 border-t pt-3">
          <button id="btnLogReload" class="btn">重新整理</button>
          <a id="btnLogExport" class="btn" href="/logs/export">匯出 CSV</a>
        </div>

        <!-- 記錄表格 -->
        <div id="usage-table" class="border-t pt-4">
          <h3 class="text-sm font-semibold mb-2">使用記錄列表</h3>
          <table class="table">
            <thead>
              <tr><th>ID</th><th>治具編號</th><th>序號</th><th>站別</th><th>使用次數</th><th>異常狀態</th><th>操作人員</th><th>備註</th><th>時間</th><th></th></tr>
            </thead>
            <tbody id="usage-tbody"></tbody>
          </table>
        </div>

        <div id="replacement-table" class="border-t pt-4 hidden">
          <h3 class="text-sm font-semibold mb-2">更換記錄列表</h3>
          <table class="table">
            <thead>
              <tr><th>ID</th><th>治具編號</th><th>序號</th><th>更換日期</th><th>更換原因</th><th>執行人員</th><th>備註</th><th>建立時間</th><th></th></tr>
            </thead>
            <tbody id="replacement-tbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- 後台管理 -->
    <section id="tab-admin" class="tab-pane hidden">
      <div class="card space-y-4">
        <div class="flex items-center justify-between">
          <h2 class="text-base font-semibold">後台管理</h2>
          <button id="btnLogout" class="btn">登出</button>
        </div>

        <!-- 後台子分頁 -->
        <nav class="flex gap-2 border-b pb-2">
          <button data-admin-tab="users" class="admin-tab tab tab-active">帳號與權限</button>
          <button data-admin-tab="smtp" class="admin-tab tab">SMTP 設定</button>
          <button data-admin-tab="fixtures" class="admin-tab tab">治具資料維護</button>
          <button data-admin-tab="machines" class="admin-tab tab">機種資料維護</button>
        </nav>

        <!-- 使用者管理 -->
        <div id="admin-users" class="admin-pane space-y-3">
          <div class="flex items-center justify-between">
            <h3 class="font-medium">帳號與權限</h3>
            <div class="flex gap-2">
              <input id="us-q" class="input" placeholder="搜尋使用者（帳號 / 角色）" />
              <button id="btnUsSearch" class="btn">搜尋</button>
              <button id="btnUsNew" class="btn btn-primary">新增帳號</button>
            </div>
          </div>
          <table class="table"><thead><tr><th>帳號</th><th>角色</th><th class="text-right">操作</th></tr></thead><tbody id="us-tbody"></tbody></table>
        </div>

        <!-- SMTP 設定 -->
        <div id="admin-smtp" class="admin-pane space-y-3 hidden">
          <h3 class="font-medium">SMTP 設定</h3>
          <div class="grid md:grid-cols-5 gap-3">
            <input id="smtp-host" class="input" placeholder="Host" />
            <input id="smtp-port" class="input" placeholder="Port" type="number" />
            <input id="smtp-user" class="input" placeholder="User" />
            <input id="smtp-pass" class="input" placeholder="Password" type="password" />
            <input id="smtp-sender" class="input" placeholder="Sender Email" />
          </div>
          <div><button id="btnSmtpSave" class="btn btn-primary">保存設定</button></div>
        </div>

        <!-- 治具資料維護 -->
        <div id="admin-fixtures" class="admin-pane space-y-3 hidden">
          <h3 class="font-medium">治具資料維護</h3>
          <div class="grid md:grid-cols-5 gap-3">
            <input id="fxm-code" class="input" placeholder="代碼*" />
            <input id="fxm-name" class="input" placeholder="名稱*" />
            <input id="fxm-spec" class="input" placeholder="規格" />
            <input id="fxm-note" class="input" placeholder="備註" />
            <div class="flex gap-2">
              <button id="btnFxmAdd" class="btn btn-primary">新增</button>
              <label class="btn cursor-pointer">匯入xlsx<input id="fxm-xlsx" type="file" accept=".xlsx" hidden/></label>
            </div>
          </div>
          <table class="table"><thead><tr><th>ID</th><th>代碼</th><th>名稱</th><th>規格</th><th>備註</th></tr></thead><tbody id="fxm-tbody"></tbody></table>
        </div>

        <!-- 機種資料維護 -->
        <div id="admin-machines" class="admin-pane space-y-3 hidden">
          <h3 class="font-medium">機種資料維護</h3>
          <div class="grid md:grid-cols-4 gap-3">
            <input id="mcm-code" class="input" placeholder="代碼*" />
            <input id="mcm-name" class="input" placeholder="名稱*" />
            <input id="mcm-note" class="input" placeholder="備註" />
            <div class="flex gap-2">
              <button id="btnMcmAdd" class="btn btn-primary">新增</button>
              <label class="btn cursor-pointer">匯入xlsx<input id="mcm-xlsx" type="file" accept=".xlsx" hidden/></label>
            </div>
          </div>
          <table class="table"><thead><tr><th>ID</th><th>代碼</th><th>名稱</th><th>備註</th></tr></thead><tbody id="mcm-tbody"></tbody></table>
        </div>
      </div>
    </section>
  </main>

  <!-- 登入 Modal -->
  <div id="loginModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center">
    <div class="bg-white rounded-2xl p-6 w-[360px] space-y-3">
      <h3 class="text-base font-semibold">登入</h3>
      <input id="inpUser" class="input" placeholder="帳號：admin" />
      <input id="inpPass" type="password" class="input" placeholder="密碼：admin" />
      <p id="loginError" class="text-sm text-red-600 hidden"></p>
      <div class="flex gap-2 justify-end">
        <button id="btnLoginCancel" class="btn">取消</button>
        <button id="btnDoLogin" class="btn btn-primary">登入</button>
      </div>
    </div>
  </div>

  <!-- 新增治具 Modal -->
  <div id="newFixtureModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center">
    <div class="bg-white rounded-2xl p-6 w-[500px] space-y-4">
      <h3 class="text-base font-semibold">新增治具</h3>
      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="text-sm text-gray-600">名稱*</label>
          <input id="nf-name" class="input" placeholder="治具名稱" />
        </div>
        <div>
          <label class="text-sm text-gray-600">狀態*</label>
          <select id="nf-status" class="input">
            <option value="active">active</option>
            <option value="inactive">inactive</option>
          </select>
        </div>
        <div>
          <label class="text-sm text-gray-600">壽命類型*</label>
          <select id="nf-life-type" class="input">
            <option value="count">count</option>
            <option value="time">time</option>
          </select>
        </div>
        <div>
          <label class="text-sm text-gray-600">已使用次數*</label>
          <input id="nf-used" class="input" type="number" value="0" />
        </div>
        <div class="col-span-2">
          <label class="text-sm text-gray-600">壽命值*</label>
          <input id="nf-life-value" class="input" type="number" value="1000" placeholder="例如：1000" />
        </div>
      </div>
      <div class="flex gap-2 justify-end">
        <button id="btnNewFixtureCancel" class="btn">取消</button>
        <button id="btnNewFixtureSave" class="btn btn-primary">確定新增</button>
      </div>
    </div>
  </div>

<script>
/* ============ 全域設定 ============ */
const API = { path: (p)=> p.startsWith('/')? p: ('/'+p) };
const state = { user: null, materialMode: 'receive' };

async function api(path, method='GET', body, headers={}){
  const res = await fetch(API.path(path), {
    method,
    headers: {'Content-Type':'application/json', ...headers},
    body: body ? JSON.stringify(body) : undefined
  });
  const ct = res.headers.get('content-type') || '';
  const data = ct.includes('application/json') ? await res.json() : await res.text();
  if(!res.ok) throw new Error(typeof data==='string' ? data : JSON.stringify(data));
  return data;
}

/* ============ 登入 / 登出 ============ */
function showLogin(v){
  const m = document.getElementById('loginModal');
  m.classList.toggle('hidden', !v); m.classList.toggle('flex', v);
}
async function doLogin(){
  const username = document.getElementById('inpUser').value.trim();
  const password = document.getElementById('inpPass').value;
  const err = document.getElementById('loginError'); err.classList.add('hidden'); err.textContent='';
  try{
    const resp = await api('/login','POST',{username,password});
    state.user = resp; localStorage.setItem('fx.user', JSON.stringify(resp));
    renderAuth(); showLogin(false); goTab('dashboard'); loadDashboard();
    document.getElementById('mat-operator').value = username;
    document.getElementById('usage-operator').value = username;
    document.getElementById('replace-executor').value = username;
  }catch(e){ err.textContent = '登入失敗：'+e.message; err.classList.remove('hidden'); }
}
function doLogout(){ localStorage.removeItem('fx.user'); state.user=null; renderAuth(); goTab('dashboard'); }
function renderAuth(){
  const span = document.getElementById('loginState'); const btn = document.getElementById('btnLogin');
  if(state.user){
    span.textContent = `您好，${state.user.username}（${state.user.role}）`;
    btn.textContent='登出'; btn.onclick=doLogout;
    document.getElementById('mat-operator').value = state.user.username;
    document.getElementById('usage-operator').value = state.user.username;
    document.getElementById('replace-executor').value = state.user.username;
  }
  else{ span.textContent = '未登入'; btn.textContent='登入'; btn.onclick=()=>{ showLogin(true); }; }
}

/* ============ 分頁切換 ============ */
function goTab(name, skipHash = false){
  document.querySelectorAll('.tab-pane').forEach(el=> el.classList.add('hidden'));
  const pane = document.getElementById('tab-'+name); if(pane) pane.classList.remove('hidden');
  document.querySelectorAll('.tab').forEach(b=> b.classList.remove('tab-active'));
  const btn = document.querySelector(`.tab[data-tab="${name}"]`); if(btn) btn.classList.add('tab-active');

  // 更新URL hash（除非是從hash變化觸發的）
  if(!skipHash) {
    window.location.hash = name;
  }

  if(name==='dashboard') loadDashboard();
  if(name==='query') loadFixtures();
  if(name==='logs') {
    switchLogMode('usage'); // 初始化為使用記錄模式
  }
  if(name==='material') {
    switchMaterialMode('receive'); // 初始化為收料模式
  }
  if(name==='admin'){ goAdminTab('users'); }
}

/* 後台子分頁切換 */
function goAdminTab(name, skipHash = false){
  console.log('goAdminTab called with:', name);

  document.querySelectorAll('.admin-pane').forEach(el=> el.classList.add('hidden'));
  const pane = document.getElementById('admin-'+name);

  if(pane) {
    pane.classList.remove('hidden');
    console.log('Admin pane shown:', 'admin-'+name);
  } else {
    console.error('Admin pane not found:', 'admin-'+name);
  }

  document.querySelectorAll('.admin-tab').forEach(b=> b.classList.remove('tab-active'));
  const btn = document.querySelector(`.admin-tab[data-admin-tab="${name}"]`);
  if(btn) {
    btn.classList.add('tab-active');
  }

  // 更新URL hash為 admin-子標籤名稱（除非是從hash變化觸發的）
  if(!skipHash) {
    window.location.hash = 'admin-' + name;
  }

  if(name==='users') {
    console.log('Loading users...');
    loadUsers();
  }
  if(name==='smtp') {
    console.log('Loading SMTP settings...');
    loadSMTP();
  }
  if(name==='fixtures') {
    console.log('Loading fixture models...');
    loadFxModels();
  }
  if(name==='machines') {
    console.log('Loading machine models...');
    loadMcModels();
  }
}

/* ============ 儀表板 ============ */
async function loadDashboard(){
  try{
    const s = await api('/stats/summary');
    setNum('statTotalFixtures', s.total_fixtures);
    setNum('statActiveFixtures', s.active_fixtures);
    setNum('statUnderLifespan', s.under_lifespan);
    setNum('statNeedReplacement', s.need_replacement);

    // 載入最近收料記錄
    const receipts = await api('/receipts');
    document.getElementById('dash-receipts').innerHTML = (receipts||[]).slice(0,5).map(r=>`
      <tr>
        <td>${r.type||'批量'}</td><td>${r.vendor||''}</td><td>${r.order_no||''}</td>
        <td>${r.fixture_code||''}</td><td>${r.operator||''}</td><td>${r.created_at||''}</td>
      </tr>
    `).join('');

    // 載入最近退料記錄
    const returns = await api('/returns');
    document.getElementById('dash-returns').innerHTML = (returns||[]).slice(0,5).map(r=>`
      <tr>
        <td>${r.type||'批量'}</td><td>${r.vendor||''}</td><td>${r.order_no||''}</td>
        <td>${r.fixture_code||''}</td><td>${r.operator||''}</td><td>${r.created_at||''}</td>
      </tr>
    `).join('');
  }catch(e){ console.error(e); }
}
function setNum(id, v){ const el=document.getElementById(id); if(el) el.textContent = v ?? 0; }

/* ============ 收/退料 ============ */
function switchMaterialMode(mode){
  state.materialMode = mode;
  const isReceive = mode === 'receive';

  // 更新按鈕樣式
  const btnReceive = document.getElementById('btnMaterialReceive');
  const btnReturn = document.getElementById('btnMaterialReturn');

  if(btnReceive && btnReturn) {
    btnReceive.classList.toggle('btn-primary', isReceive);
    btnReceive.classList.toggle('btn', !isReceive);
    btnReturn.classList.toggle('btn-primary', !isReceive);
    btnReturn.classList.toggle('btn', isReceive);
  }

  const title = document.getElementById('mat-table-title');
  if(title) {
    title.textContent = isReceive ? '收料記錄' : '退料記錄';
  }

  loadMaterialRecords();
}

function toggleMaterialType(){
  const isBatch = document.querySelector('input[name="material-type"]:checked').value === 'batch';
  document.getElementById('batch-fields').classList.toggle('hidden', !isBatch);
  document.getElementById('single-fields').classList.toggle('hidden', isBatch);
}

async function loadMaterialRecords(){
  const endpoint = state.materialMode === 'receive' ? '/receipts' : '/returns';
  try{
    const rows = await api(endpoint);
    document.getElementById('mat-tbody').innerHTML = (rows||[]).map(r=>{
      const serial = r.type === 'batch' ? `${r.serial_start||''}-${r.serial_end||''}` : (r.serials||'');
      return `
        <tr>
          <td>${r.id}</td><td>${r.type||''}</td><td>${r.vendor||''}</td><td>${r.order_no||''}</td>
          <td>${r.fixture_code||''}</td><td>${serial}</td><td>${r.operator||''}</td>
          <td>${r.note||''}</td><td>${r.created_at||''}</td>
          <td><button class="btn" onclick="deleteMaterial(${r.id})">刪除</button></td>
        </tr>
      `;
    }).join('');
  }catch(e){ console.error(e); }
}

async function addMaterial(){
  const type = document.querySelector('input[name="material-type"]:checked').value;
  const vendor = document.getElementById('mat-vendor').value.trim();
  const order_no = document.getElementById('mat-order-no').value.trim();
  const fixture_code = document.getElementById('mat-fixture-code').value.trim();
  const operator = document.getElementById('mat-operator').value.trim();
  const note = document.getElementById('mat-note').value.trim();

  if(!vendor || !order_no || !fixture_code) {
    return alert('請填寫廠商、單號和治具編號');
  }

  const body = { type, vendor, order_no, fixture_code, operator, note };

  if(type === 'batch'){
    body.serial_start = document.getElementById('mat-serial-start').value.trim();
    body.serial_end = document.getElementById('mat-serial-end').value.trim();
    if(!body.serial_start || !body.serial_end) return alert('請填寫流水號起始和結束');
  } else {
    body.serials = document.getElementById('mat-serials').value.trim();
    if(!body.serials) return alert('請填寫序號');
  }

  const endpoint = state.materialMode === 'receive' ? '/receipts' : '/returns';
  try{
    await api(endpoint, 'POST', body);
    document.getElementById('mat-vendor').value = '';
    document.getElementById('mat-order-no').value = '';
    document.getElementById('mat-fixture-code').value = '';
    document.getElementById('mat-serial-start').value = '';
    document.getElementById('mat-serial-end').value = '';
    document.getElementById('mat-serials').value = '';
    document.getElementById('mat-note').value = '';
    loadMaterialRecords();
  }catch(e){ alert('新增失敗：'+e.message); }
}

async function deleteMaterial(id){
  if(!confirm('確定刪除？')) return;
  const endpoint = state.materialMode === 'receive' ? `/receipts/${id}` : `/returns/${id}`;
  try{
    await api(endpoint, 'DELETE');
    loadMaterialRecords();
  }catch(e){ alert('刪除失敗：'+e.message); }
}

/* ============ 查詢 / 治具管理 ============ */
async function loadFixtures(q=''){
  try{
    const rows = await api('/fixtures'+(q?`?q=${encodeURIComponent(q)}`:''));
    document.getElementById('fx-tbody').innerHTML = (rows||[]).map(r=>`
      <tr>
        <td>${r.id}</td><td>${r.name}</td><td>${r.status}</td><td>${r.used}</td><td>${r.life_value}</td>
        <td class="text-right">
          <button class="btn" onclick="editFixture(${r.id})">編輯</button>
          <button class="btn" onclick="delFixture(${r.id})">刪除</button>
        </td>
      </tr>
    `).join('');
  }catch(e){ console.error(e); }
}

function showNewFixtureModal(show){
  const m = document.getElementById('newFixtureModal');
  m.classList.toggle('hidden', !show);
  m.classList.toggle('flex', show);
}

async function saveNewFixture(){
  const name = document.getElementById('nf-name').value.trim();
  const status = document.getElementById('nf-status').value;
  const life_type = document.getElementById('nf-life-type').value;
  const used = parseInt(document.getElementById('nf-used').value || '0', 10);
  const life_value = parseInt(document.getElementById('nf-life-value').value || '0', 10);

  if(!name) return alert('請輸入治具名稱');
  if(life_value <= 0) return alert('壽命值必須大於0');

  try{
    await api('/fixtures', 'POST', {name, status, life_type, used, life_value});
    showNewFixtureModal(false);
    document.getElementById('nf-name').value = '';
    document.getElementById('nf-used').value = '0';
    document.getElementById('nf-life-value').value = '1000';
    loadFixtures();
  }catch(e){ alert('新增失敗：'+e.message); }
}

async function editFixture(id){
  const name = prompt('治具名稱：'); if(!name) return;
  const life_value = parseInt(prompt('壽命（次數）', '1000')||'1000',10);
  try{ await api(`/fixtures/${id}`,'PUT',{name,status:'active',life_type:'count',used:0,life_value}); loadFixtures(); }
  catch(e){ alert('更新失敗：'+e.message); }
}

async function delFixture(id){
  if(!confirm('確定刪除？')) return;
  try{ await api(`/fixtures/${id}`,'DELETE'); loadFixtures(); }
  catch(e){ alert('刪除失敗：'+e.message); }
}

async function importFixturesFromXlsx(inputEl){
  const f = inputEl.files[0]; if(!f) return;
  const fd = new FormData(); fd.append('file', f);
  try{
    const r = await fetch('/fixtures/import_xlsx',{method:'POST', body: fd});
    if(!r.ok){ const t=await r.text(); throw new Error(t); }
    alert('匯入成功'); loadFixtures();
  }catch(e){ alert('匯入失敗：'+e.message); }
  finally{ inputEl.value=''; }
}

/* ============ 開站數查詢 ============ */
async function calcStations(){
  const code = document.getElementById('modelCode').value.trim();
  if(!code) return alert('請輸入機種代碼');
  try{
    const data = await api(`/models/max_stations?model_code=${encodeURIComponent(code)}`);
    const tbody = Object.entries(data.stations)
      .map(([s,n])=>`<tr><td>${s}</td><td>${n}</td></tr>`).join('');
    document.getElementById('stationTable').innerHTML = tbody;
  }catch(e){ alert('查詢失敗：'+e.message); }
}

/* ============ 使用/更換記錄 ============ */
const logState = { mode: 'usage' }; // 'usage' or 'replacement'

function switchLogMode(mode){
  logState.mode = mode;
  const isUsage = mode === 'usage';

  // 切換按鈕樣式
  const btnUsage = document.getElementById('btnLogUsage');
  const btnReplacement = document.getElementById('btnLogReplacement');

  if(btnUsage && btnReplacement) {
    btnUsage.classList.toggle('btn-primary', isUsage);
    btnUsage.classList.toggle('btn', !isUsage);
    btnReplacement.classList.toggle('btn-primary', !isUsage);
    btnReplacement.classList.toggle('btn', isUsage);
  }

  // 切換表單和表格
  const usageForm = document.getElementById('usage-form');
  const replacementForm = document.getElementById('replacement-form');
  const usageTable = document.getElementById('usage-table');
  const replacementTable = document.getElementById('replacement-table');

  if(usageForm) usageForm.classList.toggle('hidden', !isUsage);
  if(replacementForm) replacementForm.classList.toggle('hidden', isUsage);
  if(usageTable) usageTable.classList.toggle('hidden', !isUsage);
  if(replacementTable) replacementTable.classList.toggle('hidden', isUsage);

  loadLogs();
}

async function loadLogs(){
  if(logState.mode === 'usage') {
    await loadUsageLogs();
  } else {
    await loadReplacementLogs();
  }
}

async function loadUsageLogs(){
  try{
    const rows = await api('/usage_logs');
    document.getElementById('usage-tbody').innerHTML = (rows||[]).map(r=>`
      <tr>
        <td>${r.log_id}</td><td>${r.fixture_id||''}</td><td>${r.serial_number||''}</td>
        <td>${r.station_id||''}</td><td>${r.use_count||''}</td><td>${r.abnormal_status||''}</td>
        <td>${r.operator||''}</td><td>${r.note||''}</td><td>${r.used_at||''}</td>
        <td><button class="btn" onclick="deleteUsageLog(${r.log_id})">刪除</button></td>
      </tr>
    `).join('');
  }catch(e){ console.error(e); }
}

async function loadReplacementLogs(){
  try{
    const rows = await api('/replacement_logs');
    document.getElementById('replacement-tbody').innerHTML = (rows||[]).map(r=>`
      <tr>
        <td>${r.replacement_id}</td><td>${r.fixture_id||''}</td><td>${r.serial_number||''}</td>
        <td>${r.replacement_date||''}</td><td>${r.reason||''}</td><td>${r.executor||''}</td>
        <td>${r.note||''}</td><td>${r.created_at||''}</td>
        <td><button class="btn" onclick="deleteReplacementLog(${r.replacement_id})">刪除</button></td>
      </tr>
    `).join('');
  }catch(e){ console.error(e); }
}

async function addUsageLog(){
  const fixture_id = document.getElementById('usage-fixture-id').value.trim();
  const serial_number = document.getElementById('usage-serial').value.trim();
  const station_id = document.getElementById('usage-station').value.trim();
  const use_count = parseInt(document.getElementById('usage-count').value) || 1;
  const abnormal_status = document.getElementById('usage-abnormal').value.trim();
  const operator = document.getElementById('usage-operator').value.trim();
  const note = document.getElementById('usage-note').value.trim();

  if(!fixture_id) return alert('請填寫治具編號');

  try{
    await api('/usage_logs','POST',{
      fixture_id,
      serial_number: serial_number || null,
      station_id: station_id ? parseInt(station_id) : null,
      use_count,
      abnormal_status: abnormal_status || null,
      note: note || null,
      operator: operator || null
    });
    document.getElementById('usage-fixture-id').value='';
    document.getElementById('usage-serial').value='';
    document.getElementById('usage-station').value='';
    document.getElementById('usage-count').value='1';
    document.getElementById('usage-abnormal').value='';
    document.getElementById('usage-note').value='';
    loadUsageLogs();
  }catch(e){ alert('新增失敗：'+e.message); }
}

async function addReplacementLog(){
  const fixture_id = document.getElementById('replace-fixture-id').value.trim();
  const serial_number = document.getElementById('replace-serial').value.trim();
  const replacement_date = document.getElementById('replace-date').value;
  const executor = document.getElementById('replace-executor').value.trim();
  const reason = document.getElementById('replace-reason').value.trim();
  const note = document.getElementById('replace-note').value.trim();

  if(!fixture_id || !replacement_date) return alert('請填寫治具編號和更換日期');

  try{
    await api('/replacement_logs','POST',{
      fixture_id,
      serial_number: serial_number || null,
      replacement_date,
      reason: reason || null,
      executor: executor || null,
      note: note || null
    });
    document.getElementById('replace-fixture-id').value='';
    document.getElementById('replace-serial').value='';
    document.getElementById('replace-date').value='';
    document.getElementById('replace-reason').value='';
    document.getElementById('replace-note').value='';
    loadReplacementLogs();
  }catch(e){ alert('新增失敗：'+e.message); }
}

async function deleteUsageLog(id){
  if(!confirm('確定刪除此使用記錄？')) return;
  try{
    await api(`/usage_logs/${id}`, 'DELETE');
    loadUsageLogs();
  }catch(e){ alert('刪除失敗：'+e.message); }
}

async function deleteReplacementLog(id){
  if(!confirm('確定刪除此更換記錄？')) return;
  try{
    await api(`/replacement_logs/${id}`, 'DELETE');
    loadReplacementLogs();
  }catch(e){ alert('刪除失敗：'+e.message); }
}

/* ============ 後台：使用者管理 ============ */
async function loadUsers(){
  try{
    const rows = await api('/users');
    document.getElementById('us-tbody').innerHTML = rows.map(u=>`
      <tr>
        <td>${u.username}</td><td>${u.role}</td>
        <td class="text-right">
          <button class="btn" onclick="resetPw('${u.username}')">重設密碼</button>
          <button class="btn" onclick="delUser('${u.username}')">刪除</button>
        </td>
      </tr>
    `).join('');
  }catch(e){ console.error(e); }
}
async function newUser(){
  const username = prompt('新帳號：'); if(!username) return;
  const role = prompt('角色（admin/user）：','user') || 'user';
  const password = prompt('初始密碼（預設 1234，留空則用預設）：','');
  try{ await api('/users','POST',{username,role,password}); loadUsers(); }
  catch(e){ alert('新增失敗：'+e.message); }
}
async function resetPw(username){
  const pw = prompt(`為 ${username} 設定新密碼：`); if(!pw) return;
  try{ await api(`/users/${encodeURIComponent(username)}`,'PUT',{username, password: pw, role:'user'}); loadUsers(); }
  catch(e){ alert('重設失敗：'+e.message); }
}
async function delUser(username){
  if(!confirm(`確定刪除 ${username} ?`)) return;
  try{ await api(`/users/${encodeURIComponent(username)}`,'DELETE'); loadUsers(); }
  catch(e){ alert('刪除失敗：'+e.message); }
}

/* ============ 後台：SMTP ============ */
async function loadSMTP(){
  try{
    const settings = await api('/settings/smtp');
    const hostEl = document.getElementById('smtp-host');
    const portEl = document.getElementById('smtp-port');
    const userEl = document.getElementById('smtp-user');
    const passEl = document.getElementById('smtp-pass');
    const senderEl = document.getElementById('smtp-sender');

    if(hostEl) hostEl.value = settings.host || '';
    if(portEl) portEl.value = settings.port || '25';
    if(userEl) userEl.value = settings.user || '';
    if(passEl) passEl.value = settings.pass || '';
    if(senderEl) senderEl.value = settings.sender || '';
  }catch(e){
    console.error('loadSMTP error:', e);
    alert('載入SMTP設定失敗：' + e.message);
  }
}
async function saveSMTP(){
  const fd = new FormData();
  fd.append('host', document.getElementById('smtp-host').value.trim());
  fd.append('port', document.getElementById('smtp-port').value.trim() || '25');
  fd.append('user', document.getElementById('smtp-user').value.trim());
  fd.append('password', document.getElementById('smtp-pass').value);
  fd.append('sender', document.getElementById('smtp-sender').value.trim());
  try{
    const r = await fetch('/settings/smtp',{method:'POST', body: fd});
    if(!r.ok){ const t=await r.text(); throw new Error(t); }
    alert('SMTP 設定已保存');
  }catch(e){ alert('保存失敗：'+e.message); }
}

/* ============ 後台：治具/機種資料維護 ============ */
async function loadFxModels(){
  try{
    const rows = await api('/fixtures/models');
    const tbody = document.getElementById('fxm-tbody');
    if(tbody) {
      tbody.innerHTML = (rows||[]).map(r=>`
        <tr><td>${r.id}</td><td>${r.code||''}</td><td>${r.name||''}</td><td>${r.spec||''}</td><td>${r.note||''}</td></tr>
      `).join('');
    }
  }catch(e){
    console.error('loadFxModels error:', e);
    alert('載入治具資料失敗：' + e.message);
  }
}
async function addFxModel(){
  const code = document.getElementById('fxm-code').value.trim();
  const name = document.getElementById('fxm-name').value.trim();
  const spec = document.getElementById('fxm-spec').value.trim();
  const note = document.getElementById('fxm-note').value.trim();
  if(!code || !name) return alert('請填寫代碼與名稱');
  const fd = new FormData(); fd.append('code',code); fd.append('name',name); fd.append('spec',spec); fd.append('note',note);
  try{
    const r = await fetch('/fixtures/models',{method:'POST', body: fd});
    if(!r.ok){ const t=await r.text(); throw new Error(t); }
    document.getElementById('fxm-code').value=''; document.getElementById('fxm-name').value='';
    document.getElementById('fxm-spec').value=''; document.getElementById('fxm-note').value='';
    loadFxModels();
  }catch(e){ alert('新增失敗：'+e.message); }
}
async function importFxModels(inputEl){
  const f = inputEl.files[0]; if(!f) return;
  const fd = new FormData(); fd.append('file', f);
  try{
    const r = await fetch('/fixtures/import_xlsx',{method:'POST', body: fd});
    if(!r.ok){ const t=await r.text(); throw new Error(t); }
    alert('匯入成功'); loadFxModels();
  }catch(e){ alert('匯入失敗：'+e.message); }
  finally{ inputEl.value=''; }
}

async function loadMcModels(){
  try{
    const rows = await api('/machines/models');
    const tbody = document.getElementById('mcm-tbody');
    if(tbody) {
      tbody.innerHTML = (rows||[]).map(r=>`
        <tr><td>${r.id}</td><td>${r.code||''}</td><td>${r.name||''}</td><td>${r.note||''}</td></tr>
      `).join('');
    }
  }catch(e){
    console.error('loadMcModels error:', e);
    alert('載入機種資料失敗：' + e.message);
  }
}
async function addMcModel(){
  const code = document.getElementById('mcm-code').value.trim();
  const name = document.getElementById('mcm-name').value.trim();
  const note = document.getElementById('mcm-note').value.trim();
  if(!code || !name) return alert('請填寫代碼與名稱');
  const fd = new FormData(); fd.append('code',code); fd.append('name',name); fd.append('note',note);
  try{
    const r = await fetch('/machines/models',{method:'POST', body: fd});
    if(!r.ok){ const t=await r.text(); throw new Error(t); }
    document.getElementById('mcm-code').value=''; document.getElementById('mcm-name').value=''; document.getElementById('mcm-note').value='';
    loadMcModels();
  }catch(e){ alert('新增失敗：'+e.message); }
}
async function importMcModels(inputEl){
  const f = inputEl.files[0]; if(!f) return;
  const fd = new FormData(); fd.append('file', f);
  try{
    const r = await fetch('/machines/import_xlsx',{method:'POST', body: fd});
    if(!r.ok){ const t=await r.text(); throw new Error(t); }
    alert('匯入成功'); loadMcModels();
  }catch(e){ alert('匯入失敗：'+e.message); }
  finally{ inputEl.value=''; }
}

/* ============ 綁定事件與啟動 ============ */
function bindUI(){
  // 安全綁定函數
  const safeBind = (id, event, handler) => {
    const el = document.getElementById(id);
    if(el) {
      el[event] = handler;
    } else {
      console.warn(`Element not found: ${id}`);
    }
  };

  safeBind('btnLogin', 'onclick', ()=> showLogin(true));
  safeBind('btnLoginCancel', 'onclick', ()=> showLogin(false));
  safeBind('btnDoLogin', 'onclick', doLogin);
  safeBind('btnLogout', 'onclick', doLogout);

  // 收/退料
  safeBind('btnMaterialReceive', 'onclick', ()=> switchMaterialMode('receive'));
  safeBind('btnMaterialReturn', 'onclick', ()=> switchMaterialMode('return'));
  document.querySelectorAll('input[name="material-type"]').forEach(r=> r.onchange = toggleMaterialType);
  safeBind('btnMatAdd', 'onclick', addMaterial);
  safeBind('btnMatReload', 'onclick', loadMaterialRecords);

  // 查詢
  safeBind('btnFxSearch', 'onclick', ()=> {
    const q = document.getElementById('fx-q');
    loadFixtures(q ? q.value.trim() : '');
  });
  safeBind('btnFxNew', 'onclick', ()=> showNewFixtureModal(true));
  safeBind('btnNewFixtureCancel', 'onclick', ()=> showNewFixtureModal(false));
  safeBind('btnNewFixtureSave', 'onclick', saveNewFixture);

  const fxImport = document.getElementById('fx-import');
  if(fxImport) fxImport.addEventListener('change', e=> importFixturesFromXlsx(e.target));

  safeBind('btnCalcStations', 'onclick', calcStations);

  // 記錄
  safeBind('btnLogUsage', 'onclick', ()=> switchLogMode('usage'));
  safeBind('btnLogReplacement', 'onclick', ()=> switchLogMode('replacement'));
  safeBind('btnUsageAdd', 'onclick', addUsageLog);
  safeBind('btnReplaceAdd', 'onclick', addReplacementLog);
  safeBind('btnLogReload', 'onclick', loadLogs);

  // 後台
  document.querySelectorAll('.admin-tab').forEach(b=> {
    b.addEventListener('click', ()=> {
      const tab = b.dataset.adminTab;
      console.log('Admin tab clicked:', tab);
      goAdminTab(tab);
    });
  });

  safeBind('btnUsSearch', 'onclick', loadUsers);
  safeBind('btnUsNew', 'onclick', newUser);
  safeBind('btnSmtpSave', 'onclick', saveSMTP);
  safeBind('btnFxmAdd', 'onclick', addFxModel);

  const fxmXlsx = document.getElementById('fxm-xlsx');
  if(fxmXlsx) fxmXlsx.addEventListener('change', e=> importFxModels(e.target));

  safeBind('btnMcmAdd', 'onclick', addMcModel);

  const mcmXlsx = document.getElementById('mcm-xlsx');
  if(mcmXlsx) mcmXlsx.addEventListener('change', e=> importMcModels(e.target));

  console.log('UI binding completed');
}

(function init(){
  try{ state.user = JSON.parse(localStorage.getItem('fx.user') || 'null'); }catch{}
  renderAuth();
  document.querySelectorAll('.tab').forEach(b=> b.addEventListener('click', ()=> goTab(b.dataset.tab)));
  bindUI();

  // 處理URL hash變化
  window.addEventListener('hashchange', handleHashChange);

  // 初始化時根據hash載入對應頁面
  const hash = window.location.hash.substring(1); // 移除 # 符號
  if(hash) {
    handleHashChange();
  } else {
    goTab('dashboard');
    loadDashboard();
  }
})();

// 處理hash變化
function handleHashChange(){
  const hash = window.location.hash.substring(1);
  console.log('Hash changed to:', hash);

  if(!hash) {
    goTab('dashboard', true);
    return;
  }

  // 檢查是否為後台管理的子頁面
  if(hash.startsWith('admin-')) {
    const subTab = hash.substring(6); // 移除 'admin-' 前綴
    goTab('admin', true);
    goAdminTab(subTab, true);
  } else {
    // 一般頁面
    const validTabs = ['dashboard', 'material', 'query', 'openstations', 'logs', 'admin'];
    if(validTabs.includes(hash)) {
      goTab(hash, true);
    } else {
      goTab('dashboard', true);
    }
  }
}
</script>
</body>
</html>