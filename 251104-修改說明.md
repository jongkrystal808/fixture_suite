# 治具管理系統修改說明

根據測報提出的問題，已完成以下修改：

## 一、資料庫結構修改

### 1. 新增使用記錄表 (usage_logs)
```sql
CREATE TABLE usage_logs (
    log_id INT AUTO_INCREMENT PRIMARY KEY,
    fixture_id VARCHAR(50) NOT NULL,
    serial_number VARCHAR(100),  -- 可選，對應特定序號
    station_id INT,
    use_count INT DEFAULT 1,
    abnormal_status VARCHAR(255),
    note TEXT,
    operator VARCHAR(100),
    used_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 2. 新增更換記錄表 (replacement_logs)
```sql
CREATE TABLE replacement_logs (
    replacement_id INT AUTO_INCREMENT PRIMARY KEY,
    fixture_id VARCHAR(50) NOT NULL,
    serial_number VARCHAR(100),
    replacement_date DATE NOT NULL,
    reason TEXT,
    executor VARCHAR(100),
    note TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 二、後端API修改 (main.py)

### 新增API端點：

1. **使用記錄相關**
   - `GET /usage_logs` - 取得所有使用記錄
   - `POST /usage_logs` - 新增使用記錄
   - `DELETE /usage_logs/{log_id}` - 刪除使用記錄

2. **更換記錄相關**
   - `GET /replacement_logs` - 取得所有更換記錄
   - `POST /replacement_logs` - 新增更換記錄
   - `DELETE /replacement_logs/{replacement_id}` - 刪除更換記錄

### 新增Pydantic模型：
- `UsageLogIn` - 使用記錄輸入模型
- `ReplacementLogIn` - 更換記錄輸入模型

## 三、前端UI修改 (index.html)

### 1. 儀表板頁面
✅ **已完成**：儀表板、治具統計、治具狀況總覽三個頁面已合併為一個頁面
- 顯示治具統計總覽（治具總數、啟用中治具、壽命內治具、需更換治具）
- 顯示最近收料記錄（前5筆）
- 顯示最近退料記錄（前5筆）

### 2. 收/退料登記
✅ **已完成**：收料登記與退料登記已合併為一個分頁
- 在頂部提供收料/退料切換按鈕
- 支援批量和少量兩種模式
- **批量模式**欄位：廠商、單號、治具編號、流水號起始、流水號結束、操作人員（自動填入）、備註
- **少量模式**欄位：廠商、單號、治具編號、序號（多個序號請用逗號分隔）、操作人員（自動填入）、備註
- 操作人員默認為登錄的用戶，欄位設為只讀

### 3. 使用/更換記錄
✅ **已完成**：重新設計使用/更換記錄頁面
- 使用類似收退料的佈局結構
- 在頂部提供使用記錄/更換記錄切換按鈕

**使用記錄欄位：**
- 治具編號（必填）
- 序號（選填）
- 站別ID（選填）
- 使用次數（必填，默認1）
- 異常狀態（選填）
- 操作人員（自動填入，只讀）
- 備註（選填）

**更換記錄欄位：**
- 治具編號（必填）
- 序號（選填）
- 更換日期（必填）
- 執行人員（自動填入，只讀）
- 更換原因（選填）
- 備註（選填）

### 4. 後台管理模組
✅ **已修復**：後台管理模組中的SMTP設定、治具資料維護、機種資料維護功能正常
- 所有子模組均可正常進入和操作
- 治具資料維護支援：代碼、名稱、規格、備註四個欄位
- 機種資料維護支援：代碼、名稱、備註三個欄位

### 5. 查詢頁面
⚠️ **待完善**：新增治具系統目前採用模態框方式，已包含所有必要欄位（名稱、狀態、壽命類型、已使用次數、壽命值）

## 四、功能改進

### 1. 自動填充操作人員
- 登錄後，收料人員、退料人員、使用記錄操作人員、更換記錄執行人員會自動填入當前登錄用戶名
- 這些欄位設為只讀，防止修改

### 2. UI一致性改進
- 收/退料頁面的按鈕UI已優化，使用主色按鈕表示當前模式
- 使用/更換記錄頁面採用相同的UI設計模式

### 3. 資料表格完整性
- 所有記錄表格都包含刪除功能
- 表格顯示所有相關欄位資訊

## 五、測試建議

1. **資料庫測試**
   - 檢查 `usage_logs` 和 `replacement_logs` 表是否正確創建
   - 測試各API端點的增刪查功能

2. **前端測試**
   - 測試登錄後操作人員欄位是否自動填充
   - 測試收/退料模式切換功能
   - 測試使用/更換記錄模式切換功能
   - 測試批量和少量模式的切換
   - 測試所有新增和刪除功能

3. **後台管理測試**
   - 確認可以正常進入SMTP設定
   - 確認可以正常進入治具資料維護並新增資料
   - 確認可以正常進入機種資料維護並新增資料

## 六、部署說明

1. 替換現有的 `main.py` 和 `index.html` 檔案
2. 重新啟動應用程式
3. 資料庫表格會自動創建（使用 `init_tables()` 函數）
4. 首次登錄使用默認管理員帳號：admin / admin

## 七、注意事項

1. 舊的 `logs` 表仍然保留，未刪除（以防資料遺失）
2. 新的使用/更換記錄使用新的資料表結構
3. 所有API端點都已測試基本結構，但建議在實際環境中進行完整測試
4. 操作人員欄位依賴於用戶登錄狀態，請確保用戶已登錄後再進行操作

## 八、未來改進建議

1. **查詢頁面增強**：可以考慮將新增治具的模態框改為完整表格式輸入
2. **資料驗證**：增加更多前端和後端的資料驗證邏輯
3. **批次操作**：在使用/更換記錄中也可以考慮支援批次輸入
4. **報表功能**：可以增加更多統計報表和圖表展示功能
